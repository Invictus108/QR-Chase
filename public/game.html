<!DOCTYPE html>
<html>

<head>
  <title>QR Chase</title>
  <script src="/socket.io/socket.io.js"></script>
  <!-- Include howler (audio library) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/howler/2.2.4/howler.min.js" integrity="sha512-xi/RZRIF/S0hJ+yJJYuZ5yk6/8pCiRlEXZzoguSMl+vk2i3m6UjUO/WcZ11blRL/O+rnj94JRGwt/CHbc9+6EA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <!--  -->
  <!-- Include nice notifications package -->
  <link rel="stylesheet" href="butterup.min.css" />
  <script src="butterup.min.js"></script>
  <meta charset="UTF-8"> 
  <meta name="viewport"content="width=device-width, initial-scale=1.0"> 
  <!-- Include the QRious library -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>

  <script src="https://unpkg.com/html5-qrcode"></script>
  <link rel="stylesheet" href="style.css">

</head>

<body>

  <center>
  <!-- <h1 id="notification">Notifications</h1> -->
    </center>
  
  <!-- <button onclick="scanQRCode()">Scan QR Code</button> -->
  <div id="scan"></div>
  <center><h4>Player List</h4></center> 
  <center><div id="players"></div></center>
  <br>

  <center>
   <button onClick="window.location.replace(`index.html`);">Leave</button>
  </center>

  <script>
      let isTagged;
      // connect to socket
      var socket = io()
      const jsonData = document.cookie.split('; ').reduce((prev, current) => {
        const [name, ...value] = current.split('=');
        prev[name] = value.join('=');
        return prev;
      }, {});

      if (!jsonData.username || !jsonData.room) window.location.replace("/");

    const winSound = new Howl({
        src: ['win.mp3'],
        format: ['mp3'],
        autoplay: false,
        loop: false,
        volume: 0.5,
      });

    let theNotif;

    winSound.on('end', () => {
      butterup.toast({
        title:'Notification',
        message: theNotif,
        location:'top-center',
      });
      setTimeout(() => {
        window.location.replace(`index.html`);
      }, 3000);
    });

      //recive updated data from player joining or being tagged
      socket.on("update", ({ data, notif }) => {
        console.log("update", data);
        console.log('notif', notif)
        butterup.toast({
          title:'Notification',
          message: notif ?? "",
          location:'top-center',
        });
        // document.getElementById('notification').innerHTML = notif ?? "";
        div = document.getElementById('players')

        while (div.firstChild) {
          div.removeChild(div.firstChild);
        }

        for(let i = 0; i < data.length; i++){
          const newContent = document.createTextNode(data[i]);
          const break1 = document.createElement('br');
          // add the text node to the newly created div
          div.appendChild(newContent);
          div.appendChild(break1)
        }

        if (notif.toLowerCase().includes('you won')) {
          theNotif = notif;
          winSound.play();
          setTimeout(() => {
            window.location.replace(`index.html`);
          }, 5000);
        }

      });
    
      setTimeout(function() {
        socket.emit("loaded2");
      }, 500);
      
      
      scanQRCode();
      // socket.on("loaded", (data) => {
      //   console.log("update", data)
      //   div = document.getElementById('players')

      //   while (div.firstChild) {
      //     div.removeChild(div.firstChild);
      //   }

      //   for(let i = 0; i < data.length; i++){
      //     const newContent = document.createTextNode(data[i]);
      //     const break1 = document.createElement('br');
      //     // add the text node to the newly created div
      //     div.appendChild(newContent);
      //     div.appendChild(break1)
      //   }

      // });
      //scan qr code and send data to backend
      function scanQRCode() {
        function onScanSuccess(decodeText, decodeResult) {
          console.log(decodeText)
          const jsonObject = JSON.parse(decodeText);

          if (!isTagged) {
          socket.emit("tagged", jsonObject)
          }

        }

        const htmlscanner = new Html5QrcodeScanner(
          "scan",
          {fps: 60, qrbos: 250}
        );
        htmlscanner.render(onScanSuccess);
        // let i = 0;
        // while (i < 30) {
        //   i++
        //   console.log(htmlscanner.cameraScanImage)
        // }
      }

       const deathSound = new Howl({
        src: ['death.mp3'],
        format: ['mp3'],
        autoplay: false,
        loop: false,
        volume: 0.5,
      });

    let dataMessage;

      deathSound.on('end', () => {
        butterup.toast({
          title:'Notification',
          message: dataMessage ?? 'You died! 🙁',
          location:'top-center',
        });
        setTimeout(() => {
          window.location.replace(`index.html`);
        }, 3000);
      });

      //play death sound if tagged
      socket.on("dead", (data) => {
        // alert after sound finishes playing
        dataMessage = data.message;
        isTagged = true;
        deathSound.play();
      });

  </script>
</body>

</html>